<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frizzball - Smart Weather Forecast for All Hair Types</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left h1 {
            font-size: 2.8em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-left p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .hair-avatar {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 18px;
            border-radius: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .hair-avatar:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .avatar-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .avatar-text .name {
            font-size: 14px;
            font-weight: bold;
        }

        .avatar-text .type {
            font-size: 12px;
            opacity: 0.8;
        }



        .day-switcher {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .day-button {
            flex: 1;
            padding: 12px 15px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 14px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .day-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .weather-cards {
            display: grid;
            gap: 15px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .weather-card {
            text-align: center;
            padding: 25px;
        }

        .weather-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .temperature {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .description {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }

        .feels-like {
            font-size: 1em;
            color: #888;
        }

        .frizz-card {
            text-align: center;
            padding: 20px;
        }

        .frizz-risk {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 10px 20px;
            border-radius: 25px;
        }

        .risk-low {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .risk-moderate {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }

        .risk-high {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .uv-card {
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .uv-level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .uv-value {
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .uv-label {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .uv-description {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .tips-card {
            position: relative;
        }

        .tips-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .expand-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .tips-content {
            display: none;
        }

        .tips-content.expanded {
            display: block;
            animation: expandDown 0.3s ease;
        }

        @keyframes expandDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tip-section {
            margin-bottom: 15px;
        }

        .tip-section h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .tip-section p {
            color: #666;
            line-height: 1.5;
            margin-bottom: 5px;
        }

        .location-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .location-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .location-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .location-input button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .location-input button:hover {
            transform: translateY(-2px);
        }

        .hair-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .quiz-question {
            margin-bottom: 20px;
        }

        .quiz-question h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .quiz-options {
            display: grid;
            gap: 8px;
        }

        .quiz-option {
            padding: 12px;
            background: #f5f5f5;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .quiz-option:hover {
            background: #e8e8e8;
        }

        .quiz-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-left h1 {
                font-size: 2.2em;
            }

            .location-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Hair Avatar -->
        <div class="header">
            <div class="header-left">
                <h1>Frizzball</h1>
                <p>Smart weather forecast for all hair types</p>
            </div>
            <div class="hair-avatar" id="hair-avatar">
                <div class="avatar-icon">🌀</div>
                <div class="avatar-text">
                    <div class="name">Your Hair</div>
                    <div class="type" id="avatar-type">3B Curly</div>
                </div>
            </div>
        </div>

        <!-- Location Input -->
        <div class="location-input">
            <input type="text" id="locationInput" placeholder="Enter city, state (e.g., Sacramento, CA)" />
            <button onclick="getWeatherByLocation()">Get Weather</button>
            <button onclick="getCurrentLocation()">Use My Location</button>
        </div>

        <!-- Day Switcher (Primary Navigation) -->
        <div class="day-switcher">
            <button class="day-button active" id="day-0">Today</button>
            <button class="day-button" id="day-1">Tomorrow</button>
            <button class="day-button" id="day-2">Day 3</button>
        </div>

        <!-- Weather Cards (Default to Today) -->
        <div class="weather-cards" id="weather-cards">
            <div class="card weather-card" id="weather-display">
                <div class="weather-icon">🌤️</div>
                <div class="temperature">--°F</div>
                <div class="description">Enter location for weather</div>
                <div class="feels-like">Feels like --°F</div>
            </div>

            <div class="card frizz-card" id="frizz-display">
                <div class="frizz-risk risk-low">🌿 Low Frizz Risk</div>
                <p id="frizz-message">Perfect weather for your hair! Great day for air drying.</p>
            </div>

            <div class="card humidity-card">
                <h3 id="humidity-title">💧 --% Humidity | --°F Dew Point</h3>
                <p id="humidity-explanation">Get weather data to see how humidity affects your hair!</p>
            </div>

            <!-- UV Index Card (New) -->
            <div class="card uv-card" id="uv-display" style="display: none;">
                <h3 style="color: white; margin-bottom: 15px;">
                    <span style="font-size: 1.5em;">☀️</span> UV Index
                </h3>
                <div class="uv-level">
                    <div>
                        <div class="uv-value" id="uv-value">--</div>
                        <div class="uv-label" id="uv-label">--</div>
                    </div>
                    <div style="font-size: 3em;">☀️</div>
                </div>
                <div class="uv-description" id="uv-impact">
                    <strong>UV Impact on Your Hair:</strong><br>
                    Get weather data to see UV effects on frizz.
                </div>
            </div>

            <div class="card tips-card">
                <div class="tips-header" id="tips-header">
                    <h3>💡 Hair Strategy</h3>
                    <button class="expand-button" id="expand-btn">▼</button>
                </div>
                <div class="tips-content" id="tips-content">
                    <div class="tip-section">
                        <h4>Recommended Techniques:</h4>
                        <p>Perfect weather for the plopping method - wrap wet curls in a cotton t-shirt for 20 minutes!</p>
                    </div>
                    <div class="tip-section">
                        <h4>Product Timing:</h4>
                        <p>Apply leave-in conditioner to damp hair, then scrunch with gel for definition.</p>
                    </div>
                    <div class="tip-section">
                        <h4>Styling Approach:</h4>
                        <p>Great day for air drying - your curls will thank you!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hair Profile Modal -->
    <div class="hair-profile-modal" id="hair-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeHairProfile()">&times;</button>
            <h3 style="margin-bottom: 20px; text-align: center; color: #333;">Set Up Your Hair Profile</h3>
            
            <div class="quiz-question">
                <h4>What's your hair pattern?</h4>
                <p style="font-size: 14px; color: #666; margin-bottom: 12px;">All hair types get frizzy - straight to coily, we've got you covered!</p>
                <div class="quiz-options" id="curlType">
                    <div class="quiz-option" data-value="1A">1A - Pin straight, very fine hair</div>
                    <div class="quiz-option" data-value="1B">1B - Straight with slight body</div>
                    <div class="quiz-option" data-value="1C">1C - Straight with some waves when styled</div>
                    <div class="quiz-option" data-value="2A">2A - Loose, barely-there waves</div>
                    <div class="quiz-option" data-value="2B">2B - More defined waves with some frizz</div>
                    <div class="quiz-option" data-value="2C">2C - Strong waves with definite curls</div>
                    <div class="quiz-option" data-value="3A">3A - Large, loose curls</div>
                    <div class="quiz-option" data-value="3B">3B - Springy ringlets</div>
                    <div class="quiz-option" data-value="3C">3C - Tight corkscrews</div>
                    <div class="quiz-option" data-value="4A">4A - Soft coils</div>
                    <div class="quiz-option" data-value="4B">4B - Z-pattern coils</div>
                    <div class="quiz-option" data-value="4C">4C - Tight, densely packed coils</div>
                </div>
            </div>

            <div class="quiz-question">
                <h4>Hair Porosity?</h4>
                <div class="quiz-options" id="porosity">
                    <div class="quiz-option" data-value="low">Low - Takes forever to get wet, products sit on top</div>
                    <div class="quiz-option" data-value="medium">Medium - Gets wet fairly quickly, products absorb well</div>
                    <div class="quiz-option" data-value="high">High - Gets wet immediately, needs lots of moisture</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button onclick="saveHairProfile()" style="padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer;">Save Profile</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentWeatherData = null;
        let forecastData = null;
        let currentUVData = null;
        let currentDay = 0;
        let hairProfile = {
            curlType: '3B',
            porosity: 'medium'
        };

        // UTILITY FUNCTIONS - Define these first to avoid ReferenceErrors
        function getWeatherIcon(condition) {
            const icons = {
                'Clear': '☀️',
                'Clouds': '☁️',
                'Rain': '🌧️',
                'Snow': '❄️',
                'Thunderstorm': '⛈️',
                'Drizzle': '🌦️',
                'Mist': '🌫️',
                'Fog': '🌫️'
            };
            return icons[condition] || '🌤️';
        }

        // UV Level interpretation function
        function getUVLevel(uvIndex) {
            if (uvIndex <= 2) return { level: 'Low', color: '#4CAF50' };
            if (uvIndex <= 5) return { level: 'Moderate', color: '#FFEB3B' };
            if (uvIndex <= 7) return { level: 'High', color: '#FF9800' };
            if (uvIndex <= 10) return { level: 'Very High', color: '#FF5722' };
            return { level: 'Extreme', color: '#9C27B0' };
        }

        // UV-based hair recommendations
        function getUVRecommendations(uvIndex, hairType) {
            const recommendations = {
                low: [],
                moderate: [
                    "Apply leave-in conditioner with SPF",
                    "Hydrate hair before sun exposure"
                ],
                high: [
                    "Apply leave-in conditioner with UV filters",
                    "Wear a hat during peak sun hours",
                    "Use anti-frizz serum with UV protection"
                ],
                veryHigh: [
                    "Essential: UV protection products",
                    "Wear a hat or use protective styles",
                    "Apply hair oil for barrier protection",
                    "Deep condition tonight to repair damage"
                ],
                extreme: [
                    "Maximum protection needed!",
                    "Cover hair completely when outside",
                    "Apply UV protection spray every 2 hours",
                    "Use overnight repair mask"
                ]
            };
            
            // Add hair-type specific recommendations
            if (hairType && hairType.startsWith('4')) { // Coily hair
                if (uvIndex > 5) {
                    recommendations.veryHigh.push("Extra moisture needed - UV depletes natural oils");
                }
            }
            if (hairType && (hairType.startsWith('1') || hairType.startsWith('2'))) { // Straight/Wavy
                if (uvIndex > 7) {
                    recommendations.veryHigh.push("Fine hair is extra vulnerable - use silk scarf under hat");
                }
            }
            
            if (uvIndex <= 2) return recommendations.low;
            if (uvIndex <= 5) return recommendations.moderate;
            if (uvIndex <= 7) return recommendations.high;
            if (uvIndex <= 10) return recommendations.veryHigh;
            return recommendations.extreme;
        }

        // FIX 1: Add the missing formatPlanningTips function
        function formatPlanningTips(tips, dayIndex) {
            let html = '';
            
            if (tips.techniques && tips.techniques.length > 0) {
                html += '<div class="tip-section"><h4>Recommended Techniques:</h4>';
                tips.techniques.forEach(tip => {
                    html += `<p>${tip}</p>`;
                });
                html += '</div>';
            }

            if (tips.products && tips.products.length > 0) {
                html += '<div class="tip-section"><h4>Product Strategy:</h4>';
                tips.products.forEach(tip => {
                    html += `<p>${tip}</p>`;
                });
                html += '</div>';
            }

            if (tips.styling && tips.styling.length > 0) {
                html += '<div class="tip-section"><h4>Styling Approach:</h4>';
                tips.styling.forEach(tip => {
                    html += `<p>${tip}</p>`;
                });
                html += '</div>';
            }

            // Add UV Protection section if UV data exists
            if (tips.uvProtection && tips.uvProtection.length > 0) {
                html += '<div class="tip-section"><h4>UV Protection:</h4>';
                tips.uvProtection.forEach(tip => {
                    html += `<p>${tip}</p>`;
                });
                html += '</div>';
            }

            if (tips.education) {
                html += '<div class="tip-section"><h4>Hair Behavior Today:</h4>';
                html += `<p>${tips.education}</p></div>`;
            }

            return html || '<p>Complete your hair profile for personalized tips!</p>';
        }

        function processForecastData(forecastRaw) {
            console.log('Processing forecast data...');
            const dailyData = {};
            
            forecastRaw.list.forEach(item => {
                const date = new Date(item.dt * 1000).toDateString();
                if (!dailyData[date]) {
                    dailyData[date] = {
                        temps: [],
                        humidity: [],
                        conditions: [],
                        dt: item.dt,
                        weather: item.weather[0]
                    };
                }
                
                dailyData[date].temps.push(item.main.temp);
                dailyData[date].humidity.push(item.main.humidity);
                dailyData[date].conditions.push(item.weather[0]);
            });
            
            // Convert to array and take first 3 days
            const processed = Object.keys(dailyData).slice(0, 3).map((date, index) => {
                const day = dailyData[date];
                return {
                    date: date,
                    temp: Math.round(day.temps.reduce((a, b) => a + b) / day.temps.length),
                    humidity: Math.round(day.humidity.reduce((a, b) => a + b) / day.humidity.length),
                    condition: day.weather.main,
                    description: day.weather.description,
                    icon: day.weather.icon,
                    dayName: index === 0 ? 'Today' : index === 1 ? 'Tomorrow' : 'Day 3'
                };
            });
            
            console.log('Forecast data processed:', processed);
            return processed;
        }

        function updateDayButtonLabels() {
            console.log('updateDayButtonLabels called');
            if (!forecastData) {
                console.log('No forecast data for day button labels');
                return;
            }

            try {
                forecastData.forEach((day, index) => {
                    const button = document.getElementById(`day-${index}`);
                    if (button) {
                        if (index === 0) {
                            button.textContent = 'Today';
                        } else if (index === 1) {
                            button.textContent = 'Tomorrow';
                        } else {
                            const date = new Date();
                            date.setDate(date.getDate() + index);
                            button.textContent = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        }
                    }
                });
                console.log('Day button labels updated successfully');
            } catch (error) {
                console.error('Error in updateDayButtonLabels:', error);
            }
        }

        // FIX 2: Update saveHairProfile to avoid errors
        function saveHairProfile() {
            console.log('Saving hair profile...');
            const curlTypeSelected = document.querySelector('#curlType .quiz-option.selected');
            const porositySelected = document.querySelector('#porosity .quiz-option.selected');

            if (curlTypeSelected) {
                hairProfile.curlType = curlTypeSelected.dataset.value;
                console.log('Selected curl type:', hairProfile.curlType);
            }
            if (porositySelected) {
                hairProfile.porosity = porositySelected.dataset.value;
                console.log('Selected porosity:', hairProfile.porosity);
            }

            // Update avatar display
            const avatarType = document.getElementById('avatar-type');
            if (avatarType) {
                avatarType.textContent = `${hairProfile.curlType} ${getHairTypeDescription(hairProfile.curlType)}`;
            }

            // Save to localStorage
            try {
                localStorage.setItem('frizzball-hair-profile', JSON.stringify(hairProfile));
                console.log('Hair profile saved to localStorage');
            } catch (error) {
                console.error('Error saving hair profile:', error);
            }

            // Close modal first
            closeHairProfile();

            // Then refresh display if we have weather data and are on the main view
            if (currentWeatherData) {
                // Use the current day's data to update display
                const dayData = currentDay === 0 ? 
                    {
                        temp: Math.round(currentWeatherData.main.temp),
                        humidity: currentWeatherData.main.humidity,
                        condition: currentWeatherData.weather[0].main,
                        description: currentWeatherData.weather[0].description,
                        uvIndex: currentUVData ? currentUVData : 0
                    } : 
                    forecastData && forecastData[currentDay] ? forecastData[currentDay] : null;
                
                if (dayData) {
                    updateDayDisplay(dayData);
                }
            }
        }

        function getHairTypeDescription(type) {
            const descriptions = {
                '1A': 'Straight', '1B': 'Straight', '1C': 'Straight',
                '2A': 'Wavy', '2B': 'Wavy', '2C': 'Wavy',
                '3A': 'Curly', '3B': 'Curly', '3C': 'Curly',
                '4A': 'Coily', '4B': 'Coily', '4C': 'Coily'
            };
            return descriptions[type] || 'Curly';
        }

        function openHairProfile() {
            console.log('Opening hair profile modal');
            document.getElementById('hair-modal').style.display = 'block';
        }

        function closeHairProfile() {
            console.log('Closing hair profile modal');
            document.getElementById('hair-modal').style.display = 'none';
        }

        // Frizzball Hair Knowledge Engine
        const FrizzballKnowledge = {
            techniques: {
                plopping: {
                    description: "Wrap wet curls in cotton t-shirt to remove water without frizz",
                    goodFor: ["1C", "2A", "2B", "2C", "3A", "3B", "3C"],
                    weather: {
                        high_humidity: "15-20 minutes max - hair may take longer to dry",
                        low_humidity: "20-30 minutes - helps maintain moisture",
                        hot_weather: "Shorter time to prevent overheating scalp"
                    }
                },
                scrunching: {
                    description: "Gently squeeze curls upward to encourage curl formation", 
                    goodFor: ["all"],
                    weather: {
                        high_humidity: "Perfect day for gel scrunching - holds definition",
                        low_humidity: "Add leave-in before scrunching to prevent dryness"
                    }
                },
                diffusing: {
                    description: "Low heat blow drying with diffuser attachment",
                    goodFor: ["2C", "3A", "3B", "3C", "4A", "4B", "4C"],
                    weather: {
                        high_humidity: "Helps set curls and reduce drying time",
                        cold_weather: "Essential when air drying isn't practical"
                    }
                }
            },

            weatherConditions: {
                high_humidity: {
                    threshold: 70,
                    effects: {
                        "1A": "May become limp and oily-looking",
                        "1B": "Slight volume increase, may lose sleekness", 
                        "1C": "Natural waves enhanced, some frizz possible",
                        "2A": "Waves more pronounced, light frizz",
                        "2B": "Defined waves but increased frizz",
                        "2C": "Enhanced curl pattern, moderate frizz",
                        "3A": "More volume and bounce, some frizz",
                        "3B": "Extra volume and definition",
                        "3C": "Maximum volume, beautiful definition",
                        "4A": "Moisturized and voluminous",
                        "4B": "Enhanced curl definition",
                        "4C": "Optimal moisture levels"
                    }
                },
                low_humidity: {
                    threshold: 30,
                    effects: {
                        "1A": "May become flyaway and static",
                        "1B": "Potential for static and dryness",
                        "1C": "Waves may fall flat, dryness possible",
                        "2A": "Waves may relax, hair may feel dry",
                        "2B": "Less definition, potential dryness",
                        "2C": "Curls may lose bounce, need moisture",
                        "3A": "Curls may become loose and dry",
                        "3B": "Less definition, increased dryness",
                        "3C": "Curls tighten, need extra moisture",
                        "4A": "May become dry and brittle",
                        "4B": "Increased shrinkage, needs moisture",
                        "4C": "Maximum shrinkage, extra hydration needed"
                    }
                }
            },

            getPersonalizedTips: function(weatherData, hairType, porosity, uvIndex) {
                const humidity = weatherData.humidity;
                const temp = weatherData.temp;
                const dewPoint = this.calculateDewPoint(weatherData.temp, weatherData.humidity);
                
                let tips = {
                    techniques: [],
                    products: [],
                    styling: [],
                    uvProtection: [],
                    education: ""
                };

                // Determine weather condition
                let condition = humidity > 70 ? 'high_humidity' : humidity < 30 ? 'low_humidity' : 'moderate';
                
                // Add technique recommendations
                Object.keys(this.techniques).forEach(technique => {
                    const tech = this.techniques[technique];
                    if (tech.goodFor.includes(hairType) || tech.goodFor.includes('all')) {
                        if (tech.weather[condition]) {
                            tips.techniques.push(`${tech.description} - ${tech.weather[condition]}`);
                        } else {
                            tips.techniques.push(tech.description);
                        }
                    }
                });

                // Add weather-specific effects
                if (this.weatherConditions[condition] && this.weatherConditions[condition].effects[hairType]) {
                    tips.education = this.weatherConditions[condition].effects[hairType];
                }

                // Add product recommendations based on conditions
                if (humidity > 70) {
                    tips.products.push("Use anti-humidity gel or mousse for hold");
                    tips.products.push("Skip heavy oils and creams today");
                    if (porosity === 'high') tips.products.push("Light protein treatment can help");
                } else if (humidity < 30) {
                    tips.products.push("Use leave-in conditioner and oils for moisture");
                    tips.products.push("Avoid alcohol-based products");
                    if (porosity === 'low') tips.products.push("Use lighter, water-based products");
                }

                // Add styling recommendations
                if (temp > 80) {
                    tips.styling.push("Perfect weather for air drying");
                    tips.styling.push("Consider protective styles for extended outdoor time");
                } else if (temp < 50) {
                    tips.styling.push("Diffusing recommended - cold air drying may take too long");
                    tips.styling.push("Use heat protectant if blow drying");
                }

                // Add UV protection recommendations to Hair Strategy
                if (uvIndex !== undefined && uvIndex > 0) {
                    const uvRecs = getUVRecommendations(uvIndex, hairType);
                    if (uvRecs && uvRecs.length > 0) {
                        tips.uvProtection = uvRecs;
                    }
                }

                return tips;
            },

            calculateDewPoint: function(temp, humidity) {
                // Simplified dew point calculation
                return temp - ((100 - humidity) / 5);
            },

            getFrizzRisk: function(humidity, dewPoint, hairType, uvIndex) {
                // Risk calculation based on hair type and weather
                let riskScore = 0;
                
                // Humidity impact (40% weight)
                if (humidity > 80) riskScore += 16;
                else if (humidity > 70) riskScore += 12;
                else if (humidity > 60) riskScore += 8;
                else if (humidity > 50) riskScore += 4;
                else if (humidity < 30) riskScore += 8;
                
                // Dew point impact (30% weight)
                if (dewPoint > 65) riskScore += 12;
                else if (dewPoint > 60) riskScore += 9;
                else if (dewPoint > 55) riskScore += 6;
                else if (dewPoint > 50) riskScore += 3;
                else if (dewPoint < 40) riskScore += 3;
                
                // UV impact (20% weight)
                if (uvIndex !== undefined && uvIndex > 0) {
                    if (uvIndex > 10) riskScore += 8;
                    else if (uvIndex > 7) riskScore += 6;
                    else if (uvIndex > 5) riskScore += 4;
                    else if (uvIndex > 3) riskScore += 2;
                }
                
                // Temperature impact (10% weight) - simplified for now
                riskScore += 2;
                
                // Hair type multiplier
                const typeMultipliers = {
                    "1A": 0.5, "1B": 0.7, "1C": 1,
                    "2A": 1.2, "2B": 1.4, "2C": 1.6,
                    "3A": 1.8, "3B": 2, "3C": 2.2,
                    "4A": 1.5, "4B": 1.3, "4C": 1.1
                };
                
                riskScore *= (typeMultipliers[hairType] || 1);
                
                if (riskScore <= 20) return { level: 'low', color: 'risk-low', icon: '🌿' };
                if (riskScore <= 40) return { level: 'moderate', color: 'risk-moderate', icon: '⚠️' };
                return { level: 'high', color: 'risk-high', icon: '🚨' };
            }
        };

        // Location and Weather Functions
        async function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    await getWeatherByCoords(lat, lon);
                },
                (error) => {
                    alert('Unable to retrieve your location. Please enter manually.');
                }
            );
        }

        async function getWeatherByLocation() {
            const location = document.getElementById('locationInput').value.trim();
            if (!location) {
                alert('Please enter a location');
                return;
            }

            try {
                // First get coordinates from location name
                const geoResponse = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(location)}&limit=1&appid=bd5e378503939ddaee76f12ad7a97608`);
                const geoData = await geoResponse.json();
                
                if (!geoData || geoData.length === 0) {
                    throw new Error('Location not found');
                }

                const { lat, lon } = geoData[0];
                await getWeatherByCoords(lat, lon);
                
            } catch (error) {
                alert('Error finding location: ' + error.message);
            }
        }

        async function getWeatherByCoords(lat, lon) {
            try {
                console.log('Getting weather for coordinates:', lat, lon);
                
                // Get current weather, forecast, and UV data
                const [currentResponse, forecastResponse, uvResponse] = await Promise.all([
                    fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=bd5e378503939ddaee76f12ad7a97608&units=imperial`),
                    fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=bd5e378503939ddaee76f12ad7a97608&units=imperial`),
                    fetch(`https://api.openweathermap.org/data/2.5/uvi?lat=${lat}&lon=${lon}&appid=bd5e378503939ddaee76f12ad7a97608`)
                ]);
                
                if (!currentResponse.ok || !forecastResponse.ok) {
                    throw new Error(`Weather API error: ${currentResponse.status} / ${forecastResponse.status}`);
                }

                currentWeatherData = await currentResponse.json();
                const forecastRaw = await forecastResponse.json();
                
                // Get UV data if available
                if (uvResponse.ok) {
                    const uvData = await uvResponse.json();
                    currentUVData = uvData.value || 0;
                    console.log('UV Index:', currentUVData);
                } else {
                    currentUVData = 0;
                }
                
                console.log('✅ WEATHER DATA RECEIVED:', currentWeatherData);
                
                // Process forecast data
                forecastData = processForecastData(forecastRaw);
                console.log('✅ FORECAST DATA PROCESSED:', forecastData);
                
                // Update day button labels
                updateDayButtonLabels();
                
                // Display current weather
                const dayData = {
                    temp: Math.round(currentWeatherData.main.temp),
                    humidity: currentWeatherData.main.humidity,
                    condition: currentWeatherData.weather[0].main,
                    description: currentWeatherData.weather[0].description,
                    feels_like: Math.round(currentWeatherData.main.feels_like),
                    uvIndex: currentUVData
                };
                
                updateDayDisplay(dayData);
                
                console.log('⭐ WEATHER UPDATE COMPLETE');
                
            } catch (error) {
                console.error('Weather error details:', error);
                alert('Error getting weather data: ' + error.message);
            }
        }

        // FIX 3: Create a unified update function for day display
        function updateDayDisplay(weatherData) {
            console.log('Updating display with:', weatherData);
            
            // Update weather card with null checks
            const tempEl = document.querySelector('.temperature');
            if (tempEl) {
                tempEl.textContent = `${weatherData.temp}°F`;
            }
            
            const descEl = document.querySelector('.description');
            if (descEl) {
                descEl.textContent = weatherData.description.charAt(0).toUpperCase() + weatherData.description.slice(1);
            }
            
            const feelsEl = document.querySelector('.feels-like');
            if (feelsEl && weatherData.feels_like) {
                feelsEl.textContent = `Feels like ${weatherData.feels_like}°F`;
            }
            
            const iconEl = document.querySelector('.weather-icon');
            if (iconEl) {
                iconEl.textContent = getWeatherIcon(weatherData.condition);
            }

            // Update humidity card
            const dewPoint = Math.round(FrizzballKnowledge.calculateDewPoint(weatherData.temp, weatherData.humidity));
            const humidityTitle = document.getElementById('humidity-title');
            if (humidityTitle) {
                humidityTitle.textContent = `💧 ${weatherData.humidity}% Humidity | ${dewPoint}°F Dew Point`;
            }
            
            const humidityExp = document.getElementById('humidity-explanation');
            if (humidityExp) {
                const explanation = getHumidityExplanation(weatherData.humidity, dewPoint, hairProfile.curlType);
                humidityExp.textContent = `"${explanation}"`;
            }

            // Update UV Index card
            if (weatherData.uvIndex !== undefined && weatherData.uvIndex > 0) {
                const uvCard = document.getElementById('uv-display');
                if (uvCard) {
                    uvCard.style.display = 'block';
                    const uvLevel = getUVLevel(weatherData.uvIndex);
                    uvCard.style.background = `linear-gradient(135deg, ${uvLevel.color}dd, ${uvLevel.color}99)`;
                    
                    const uvValue = document.getElementById('uv-value');
                    const uvLabel = document.getElementById('uv-label');
                    const uvImpact = document.getElementById('uv-impact');
                    
                    if (uvValue) uvValue.textContent = Math.round(weatherData.uvIndex);
                    if (uvLabel) uvLabel.textContent = uvLevel.level;
                    
                    if (uvImpact) {
                        let impactText = '<strong>UV Impact on Your Hair:</strong><br>';
                        if (weatherData.uvIndex > 5) {
                            impactText += 'High UV breaks down hair proteins & strips oils, significantly increasing frizz. Protection essential!';
                        } else if (weatherData.uvIndex > 2) {
                            impactText += 'Moderate UV can gradually damage hair cuticles. Some protection recommended for extended exposure.';
                        } else {
                            impactText += 'Low UV levels - minimal impact on frizz today.';
                        }
                        uvImpact.innerHTML = impactText;
                    }
                }
            } else {
                const uvCard = document.getElementById('uv-display');
                if (uvCard) {
                    uvCard.style.display = 'none';
                }
            }

            // Update frizz risk (now includes UV)
            const frizzRisk = FrizzballKnowledge.getFrizzRisk(
                weatherData.humidity, 
                dewPoint, 
                hairProfile.curlType, 
                weatherData.uvIndex || 0
            );
            const frizzElement = document.querySelector('.frizz-risk');
            if (frizzElement) {
                frizzElement.className = `frizz-risk ${frizzRisk.color}`;
                frizzElement.textContent = `${frizzRisk.icon} ${frizzRisk.level.charAt(0).toUpperCase() + frizzRisk.level.slice(1)} Frizz Risk`;
            }
            
            const frizzMessage = document.getElementById('frizz-message');
            if (frizzMessage) {
                if (frizzRisk.level === 'low') {
                    frizzMessage.textContent = 'Perfect weather for your hair! Great day for air drying.';
                } else if (frizzRisk.level === 'moderate') {
                    frizzMessage.textContent = 'Some frizz possible. Use your regular styling products.';
                } else {
                    frizzMessage.textContent = 'High frizz potential. Use anti-frizz products and avoid touching hair.';
                }
            }

            // Update tips (now includes UV recommendations in Hair Strategy)
            const tips = FrizzballKnowledge.getPersonalizedTips(
                { temp: weatherData.temp, humidity: weatherData.humidity, feels_like: weatherData.feels_like || weatherData.temp },
                hairProfile.curlType,
                hairProfile.porosity,
                weatherData.uvIndex || 0
            );
            
            updateTipsDisplay(tips);
        }

        function updateTipsDisplay(tips) {
            const tipsContent = document.getElementById('tips-content');
            if (!tipsContent) return; // Safety check
            
            let html = '';
            
            if (tips.techniques && tips.techniques.length > 0) {
                html += '<div class="tip-section"><h4>Recommended Techniques:</h4>';
                tips.techniques.forEach(tip => {
                    html += `<p>${tip}</p>`;
                });
                html += '</div>';
            }

            if (tips.products && tips.products.length > 0) {
                html += '<div class="tip-section"><h4>Product Strategy:</h4>';
                tips.products.forEach(tip => {
                    html += `<p>${tip}</p>`;
                });
                html += '</div>';
            }

            if (tips.styling && tips.styling.length > 0) {
                html += '<div class="tip-section"><h4>Styling Approach:</h4>';
                tips.styling.forEach(tip => {
                    html += `<p>${tip}</p>`;
                });
                html += '</div>';
            }

            // Add UV Protection section to Hair Strategy
            if (tips.uvProtection && tips.uvProtection.length > 0) {
                html += '<div class="tip-section"><h4>UV Protection:</h4>';
                tips.uvProtection.forEach(tip => {
                    html += `<p>${tip}</p>`;
                });
                html += '</div>';
            }

            if (tips.education) {
                html += '<div class="tip-section"><h4>Hair Behavior Today:</h4>';
                html += `<p>${tips.education}</p></div>`;
            }

            tipsContent.innerHTML = html || '<div class="tip-section"><p>Complete your hair profile for personalized tips!</p></div>';
        }

        function getHumidityExplanation(humidity, dewPoint, hairType) {
            // Practical explanation of humidity
            let explanation = `Air is holding ${humidity}% of possible moisture. `;
            
            // Dew point insight + hair type specific impact
            if (dewPoint > 65) {
                explanation += `High dew point (${dewPoint}°F) means your ${hairType} hair will absorb lots of extra moisture and get maximum volume and definition.`;
            } else if (dewPoint > 60) {
                explanation += `Dew point ${dewPoint}°F means your ${hairType} hair will absorb extra moisture and get more volume.`;
            } else if (dewPoint > 55) {
                explanation += `Moderate dew point (${dewPoint}°F) creates balanced conditions for your ${hairType} hair with some moisture absorption.`;
            } else if (dewPoint > 45) {
                explanation += `Lower dew point (${dewPoint}°F) means less moisture available - your ${hairType} hair may need extra hydration today.`;
            } else {
                explanation += `Low dew point (${dewPoint}°F) means very dry air that will pull moisture from your ${hairType} hair - focus on moisture retention.`;
            }
            
            return explanation;
        }

        // FIX 4: Update switchDay to properly handle day switching
        function switchDay(dayIndex) {
            console.log('=== SWITCHING TO DAY', dayIndex, '===');
            currentDay = dayIndex;
            
            // Update day buttons
            document.querySelectorAll('.day-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`day-${dayIndex}`).classList.add('active');
            
            // Get the appropriate data for the selected day
            let dayData;
            
            if (dayIndex === 0 && currentWeatherData) {
                // Today - use current weather
                dayData = {
                    temp: Math.round(currentWeatherData.main.temp),
                    humidity: currentWeatherData.main.humidity,
                    condition: currentWeatherData.weather[0].main,
                    description: currentWeatherData.weather[0].description,
                    feels_like: Math.round(currentWeatherData.main.feels_like),
                    uvIndex: currentUVData || 0
                };
            } else if (forecastData && forecastData[dayIndex]) {
                // Tomorrow or Day 3 - use forecast data (UV not available for future days from this API)
                dayData = {
                    ...forecastData[dayIndex],
                    uvIndex: 0  // OpenWeather doesn't provide future UV in basic API
                };
            } else {
                console.log('No data available for day', dayIndex);
                return;
            }
            
            console.log('Day data:', dayData);
            
            // Update the display with the selected day's data
            updateDayDisplay(dayData);
            
            console.log('=== DAY SWITCH COMPLETE ===');
        }

        function toggleTips() {
            console.log('Toggling tips...');
            const content = document.getElementById('tips-content');
            const button = document.getElementById('expand-btn');
            
            if (content && button) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    content.classList.add('expanded');
                    button.textContent = '▲';
                    console.log('Tips expanded');
                } else {
                    content.style.display = 'none';
                    content.classList.remove('expanded');
                    button.textContent = '▼';
                    console.log('Tips collapsed');
                }
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing Frizzball...');
            
            // Load saved hair profile
            const saved = localStorage.getItem('frizzball-hair-profile');
            if (saved) {
                try {
                    hairProfile = JSON.parse(saved);
                    const avatarType = document.getElementById('avatar-type');
                    if (avatarType) {
                        avatarType.textContent = `${hairProfile.curlType} ${getHairTypeDescription(hairProfile.curlType)}`;
                    }
                    console.log('Loaded hair profile:', hairProfile);
                } catch (error) {
                    console.error('Error loading hair profile:', error);
                }
            }

            // Set up all event listeners properly
            setupEventListeners();
            
            console.log('Frizzball initialized successfully');
        });

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Quiz option selection handlers
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('quiz-option')) {
                    const parent = e.target.parentElement;
                    parent.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
                    e.target.classList.add('selected');
                    console.log('Quiz option selected:', e.target.textContent);
                }
            });

            // Day button click handlers - SET UP PROPERLY
            const dayButtons = document.querySelectorAll('.day-button');
            dayButtons.forEach((button, index) => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Day button clicked:', index);
                    switchDay(index);
                });
            });

            // Hair avatar click handler
            const hairAvatar = document.getElementById('hair-avatar');
            if (hairAvatar) {
                hairAvatar.addEventListener('click', function() {
                    console.log('Hair avatar clicked');
                    openHairProfile();
                });
            }

            // Location input Enter key
            const locationInput = document.getElementById('locationInput');
            if (locationInput) {
                locationInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        getWeatherByLocation();
                    }
                });
            }

            // Hair modal click outside to close
            const hairModal = document.getElementById('hair-modal');
            if (hairModal) {
                hairModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeHairProfile();
                    }
                });
            }

            // Tips toggle functionality
            const tipsHeader = document.getElementById('tips-header');
            if (tipsHeader) {
                tipsHeader.addEventListener('click', function() {
                    console.log('Tips header clicked');
                    toggleTips();
                });
            }

            // Save Profile button handler
            const saveButton = document.querySelector('#hair-modal button[onclick="saveHairProfile()"]');
            if (saveButton) {
                saveButton.onclick = function(e) {
                    e.preventDefault();
                    console.log('Save Profile button clicked');
                    saveHairProfile();
                };
            }

            console.log('Event listeners set up successfully');
        }
    </script>
</body>
</html>
